# Prometheus Composition
# Creates Prometheus deployment for metrics collection

apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: monitoring-prometheus
  labels:
    component: prometheus
spec:
  compositeTypeRef:
    apiVersion: monitoring.example.org/v1alpha1
    kind: Monitoring
  
  resources:
    - name: prometheus
      base:
        apiVersion: apps/v1
        kind: Deployment
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: prometheus
          template:
            metadata:
              labels:
                app: prometheus
            spec:
              containers:
                - name: prometheus
                  image: prom/prometheus:latest
                  ports:
                    - containerPort: 9090
                  resources:
                    requests:
                      cpu: "500m"
                      memory: "1Gi"
                    limits:
                      cpu: "2000m"
                      memory: "4Gi"
                  volumeMounts:
                    - name: config
                      mountPath: /etc/prometheus
                    - name: storage
                      mountPath: /prometheus
              volumes:
                - name: config
                  configMap:
                    name: prometheus-config
                - name: storage
                  persistentVolumeClaim:
                    claimName: prometheus-storage
      
      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: spec.prometheus.enabled
          toFieldPath: metadata.annotations[crossplane.io/optional]
        
        - type: FromCompositeFieldPath
          fromFieldPath: spec.prometheus.retention
          toFieldPath: spec.template.spec.containers[0].args[0]
          transforms:
            - type: string
              string:
                fmt: "--storage.tsdb.retention.time=%s"
